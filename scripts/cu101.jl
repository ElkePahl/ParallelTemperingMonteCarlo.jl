using ParallelTemperingMonteCarlo
using Random, DelimitedFiles

#demonstration of the new version of the new code   
script_folder = @__DIR__ # folder where this script is located
data_path = joinpath(script_folder, "data") # path to data files, so "./data/"
#-------------------------------------------------------#
#-----------------------MC Params-----------------------#
#-------------------------------------------------------#


Random.seed!(1234)
n_atoms = 101
ti = 750.
tf = 1200
n_traj = 20

temp = TempGrid{n_traj}(ti,tf) 

# MC simulation details

mc_cycles = 2000  #default 20% equilibration cycles on top


mc_sample = 1  #sample every mc_sample MC cycles

#move_atom=AtomMove(n_atoms) #move strategy (here only atom moves, n_atoms per MC cycle)
displ_atom = 0.1 # Angstrom
n_adjust = 100

max_displ_atom = [0.1*sqrt(displ_atom*temp.t_grid[i]) for i in 1:n_traj]

mc_params = MCParams(mc_cycles, n_traj, n_atoms, mc_sample = mc_sample, n_adjust = n_adjust)


#-------------------------------------------------------------#
#----------------------Potential------------------------------#
#-------------------------------------------------------------#

evtohartree = 0.0367493
nmtobohr = 18.8973
#parameters taken from L Vocadlo etal J Chem Phys V120N6 2004
n = 8.482
m = 4.692
ϵ = evtohartree*0.0370
a = 0.25*nmtobohr
C = 27.561

pot = EmbeddedAtomPotential(n,m,ϵ,C,a)

#-------------------------------------------------------------#
#------------------------Move Strategy------------------------#
#-------------------------------------------------------------#
ensemble = NVT(n_atoms)
move_strat = MoveStrategy(ensemble)
#-------------------------------------------------------------#
#-----------------------Starting Config-----------------------#
#-------------------------------------------------------------#

pos_cu101 = [[10.37837124, 10.34436535, 14.44486097],
[7.94202653, 10.16670763, 13.80890268],
[9.47226682, 8.11396667, 13.66196437],
[5.48624304, 9.98269714, 13.08598569],
[6.99878827, 7.91233039, 13.00679224],
[9.32068459, 12.23958719, 13.14613649],
[8.54576483, 5.87484691, 12.79703852],
[11.80988512, 8.89634069, 12.9523559],
[3.09404123, 9.80073713, 12.29943107],
[4.56158385, 7.74830086, 12.22279336],
[6.85460477, 12.07916762, 12.49186036],
[11.72744397, 11.44952298, 12.61279373],
[6.09013845, 5.69190023, 12.08015276],
[7.62869879, 3.70126652, 11.87726066],
[10.91006211, 6.62883066, 12.14023344],
[9.75280876, 10.04088391, 12.06984145],
[4.42736798, 11.87183105, 11.71329285],
[8.24387536, 14.08620137, 11.76953933],
[7.32528033, 9.86235363, 11.41493464],
[9.95763567, 4.42293994, 11.22334763],
[8.84581494, 7.8190103, 11.27089133],
[13.21828264, 7.44412281, 11.37263354],
[10.66906252, 13.35301757, 11.2990577],
[5.81563779, 13.9029655, 11.06554003],
[13.18354832, 10.00155265, 11.09052109],
[4.9351008, 9.67785557, 10.64665899],
[6.40389684, 7.63613097, 10.5550296],
[8.69559169, 11.93508577, 10.72749644],
[2.92567402, 8.24257014, 10.31110904],
[7.93062516, 5.64018209, 10.36900217],
[12.29273014, 5.21047097, 10.50934153],
[4.40623328, 6.15978041, 10.20468368],
[11.16985352, 8.60046502, 10.56338027],
[13.03240057, 12.51489948, 10.70887709],
[5.97247414, 4.1493554, 10.01923569],
[2.81765977, 10.80185215, 10.00368351],
[11.08439125, 11.15062426, 10.19816114],
[6.28468589, 11.74943697, 10.02302984],
[10.24729668, 6.3748246, 9.70294032],
[8.37789659, 3.36035483, 9.48604912],
[14.55680325, 6.03660954, 9.75954576],
[9.13315923, 9.75260437, 9.69992179],
[4.15575951, 12.87803203, 9.39518225],
[14.5367743, 8.55250181, 9.47359002],
[7.63534548, 13.85132166, 9.35331558],
[6.75830192, 9.56287709, 8.9941946],
[10.73171687, 4.08399547, 8.80268902],
[8.22670734, 7.5643173, 8.85397293],
[12.51222488, 7.19042369, 8.96780767],
[14.42906266, 11.07501152, 9.15938684],
[4.78749459, 8.13225831, 8.62570423],
[6.28623094, 6.11412747, 8.47731081],
[4.35218116, 4.67969368, 8.13346804],
[10.05606555, 13.1330617, 8.85495105],
[6.71980788, 3.81328465, 7.61056728],
[12.46640629, 9.71962391, 8.65355234],
[4.6978056, 10.67538015, 8.32127802],
[4.63231309, 6.59839343, 6.54946101],
[8.09210768, 11.64935924, 8.32914283],
[10.48536403, 8.33930158, 8.16798897],
[8.67359501, 5.33040176, 7.94792362],
[13.03341724, 4.92456961, 8.07072807],
[12.41849404, 12.28014843, 8.29363925],
[9.13803738, 3.10881437, 7.07251205],
[2.65613042, 9.25066845, 7.99361617],
[10.44364903, 10.87676778, 7.80798586],
[5.98804559, 12.83360304, 7.65819364],
[8.52096264, 9.46053861, 7.37260334],
[11.44892745, 3.87978546, 6.377027],
[10.96763642, 6.10344968, 7.25493171],
[14.44791961, 6.98367265, 7.42719844],
[6.59823035, 8.04466521, 6.93595398],
[9.76608875, 8.97851676, 3.42731642],
[10.70203909, 11.23801749, 4.30258917],
[7.29071299, 8.83002359, 2.75015477],
[12.22881547, 9.13227785, 4.24918797],
[8.20349176, 11.07273892, 3.54629606],
[9.41404962, 5.02812102, 5.48901587],
[9.1262315, 13.26326076, 4.46575675],
[5.8306737, 10.27060545, 4.2997193],
[8.34321944, 6.90185802, 4.05778202],
[6.76619801, 12.53133978, 5.17395658],
[10.34527499, 9.31051734, 5.80570606],
[4.46205805, 9.14776704, 6.23190423],
[14.24216033, 7.96175083, 5.11636997],
[12.39177408, 10.72983305, 6.23875544],
[4.43868096, 11.6920802, 5.97492629],
[7.9076611, 9.14451956, 5.07033013],
[14.41805393, 9.50931212, 7.12270115],
[8.94977078, 7.2720974, 6.41397147],
[6.99510952, 5.74233946, 5.9970634],
[8.82343906, 11.35571261, 5.92571441],
[12.91498973, 5.88305897, 5.71995883],
[12.36153718, 8.15888861, 6.62322552],
[2.63821249, 11.77027191, 7.68621243],
[5.93042785, 7.69398904, 4.5922026],
[10.79731928, 12.82766405, 6.35050701],
[6.50749528, 10.57206201, 6.65600365],
[10.86471684, 7.04438815, 4.81287309],
[8.38265424, 13.62044367, 6.88514476],
[2.83880427, 6.70606892, 8.28598331]]
#convert to Bohr


AtoBohr = 1.8897259886
pos_cu101 .*= AtoBohr 
 
 # we do not have a centred config, correcting this now
 
cofm = [sum([pos[1] for pos in pos_cu101]),sum([pos[2] for pos in pos_cu101]),sum([pos[3] for pos in pos_cu101])]./101

for element in pos_cu101
    element .-=cofm 
end

length(pos_cu101) == n_atoms || error("number of atoms and positions not the same - check starting config")


#histogram information
n_bin = 100

#boundary conditions
bc_cu101 = SphericalBC(radius=16*AtoBohr)   #5.32 Angstrom
start_config = Config(pos_cu101, bc_cu101)

#@profview ptmc_run!(mc_params,temp,start_config,pot,ensemble)

@time ptmc_run!(mc_params,temp,start_config,pot,ensemble;save=1000)

