using Printf
using LinearAlgebra

pos_ar216 = [[ 1.56624152,  0.90426996,  0.        ],
[ 4.69872456,  0.90426996,  0.        ],
[ 7.8312076 ,  0.90426996,  0.        ],
[10.96369064,  0.90426996,  0.        ],
[14.09617368,  0.90426996,  0.        ],
[17.22865672,  0.90426996,  0.        ],
[ 3.13248304,  3.61707985,  0.        ],
[ 6.26496608,  3.61707985,  0.        ],
[ 9.39744912,  3.61707985,  0.        ],
[12.52993216,  3.61707985,  0.        ],
[15.6624152 ,  3.61707985,  0.        ],
[18.79489824,  3.61707985,  0.        ],
[ 4.69872456,  6.32988974,  0.        ],
[ 7.8312076 ,  6.32988974,  0.        ],
[10.96369064,  6.32988974,  0.        ],
[14.09617368,  6.32988974,  0.        ],
[17.22865672,  6.32988974,  0.        ],
[20.36113976,  6.32988974,  0.        ],
[ 6.26496608,  9.04269963,  0.        ],
[ 9.39744912,  9.04269963,  0.        ],
[12.52993216,  9.04269963,  0.        ],
[15.6624152 ,  9.04269963,  0.        ],
[18.79489824,  9.04269963,  0.        ],
[21.92738128,  9.04269963,  0.        ],
[ 7.8312076 , 11.75550952,  0.        ],
[10.96369064, 11.75550952,  0.        ],
[14.09617368, 11.75550952,  0.        ],
[17.22865672, 11.75550952,  0.        ],
[20.36113976, 11.75550952,  0.        ],
[23.4936228 , 11.75550952,  0.        ],
[ 9.39744912, 14.46831941,  0.        ],
[12.52993216, 14.46831941,  0.        ],
[15.6624152 , 14.46831941,  0.        ],
[18.79489824, 14.46831941,  0.        ],
[21.92738128, 14.46831941,  0.        ],
[25.05986433, 14.46831941,  0.        ],
[ 0.        ,  1.80853993,  2.55766169],
[ 3.13248304,  1.80853993,  2.55766169],
[ 6.26496608,  1.80853993,  2.55766169],
[ 9.39744912,  1.80853993,  2.55766169],
[12.52993216,  1.80853993,  2.55766169],
[15.6624152 ,  1.80853993,  2.55766169],
[ 1.56624152,  4.52134982,  2.55766169],
[ 4.69872456,  4.52134982,  2.55766169],
[ 7.8312076 ,  4.52134982,  2.55766169],
[10.96369064,  4.52134982,  2.55766169],
[14.09617368,  4.52134982,  2.55766169],
[17.22865672,  4.52134982,  2.55766169],
[ 3.13248304,  7.23415971,  2.55766169],
[ 6.26496608,  7.23415971,  2.55766169],
[ 9.39744912,  7.23415971,  2.55766169],
[12.52993216,  7.23415971,  2.55766169],
[15.6624152 ,  7.23415971,  2.55766169],
[18.79489824,  7.23415971,  2.55766169],
[ 4.69872456,  9.9469696 ,  2.55766169],
[ 7.8312076 ,  9.9469696 ,  2.55766169],
[10.96369064,  9.9469696 ,  2.55766169],
[14.09617368,  9.9469696 ,  2.55766169],
[17.22865672,  9.9469696 ,  2.55766169],
[20.36113976,  9.9469696 ,  2.55766169],
[ 6.26496608, 12.65977949,  2.55766169],
[ 9.39744912, 12.65977949,  2.55766169],
[12.52993216, 12.65977949,  2.55766169],
[15.6624152 , 12.65977949,  2.55766169],
[18.79489824, 12.65977949,  2.55766169],
[21.92738128, 12.65977949,  2.55766169],
[ 7.8312076 , 15.37258938,  2.55766169],
[10.96369064, 15.37258938,  2.55766169],
[14.09617368, 15.37258938,  2.55766169],
[17.22865672, 15.37258938,  2.55766169],
[20.36113976, 15.37258938,  2.55766169],
[23.4936228 , 15.37258938,  2.55766169],
[ 0.        ,  0.        ,  5.11532339],
[ 3.13248304,  0.        ,  5.11532339],
[ 6.26496608,  0.        ,  5.11532339],
[ 9.39744912,  0.        ,  5.11532339],
[12.52993216,  0.        ,  5.11532339],
[15.6624152 ,  0.        ,  5.11532339],
[ 1.56624152,  2.71280989,  5.11532339],
[ 4.69872456,  2.71280989,  5.11532339],
[ 7.8312076 ,  2.71280989,  5.11532339],
[10.96369064,  2.71280989,  5.11532339],
[14.09617368,  2.71280989,  5.11532339],
[17.22865672,  2.71280989,  5.11532339],
[ 3.13248304,  5.42561978,  5.11532339],
[ 6.26496608,  5.42561978,  5.11532339],
[ 9.39744912,  5.42561978,  5.11532339],
[12.52993216,  5.42561978,  5.11532339],
[15.6624152 ,  5.42561978,  5.11532339],
[18.79489824,  5.42561978,  5.11532339],
[ 4.69872456,  8.13842967,  5.11532339],
[ 7.8312076 ,  8.13842967,  5.11532339],
[10.96369064,  8.13842967,  5.11532339],
[14.09617368,  8.13842967,  5.11532339],
[17.22865672,  8.13842967,  5.11532339],
[20.36113976,  8.13842967,  5.11532339],
[ 6.26496608, 10.85123956,  5.11532339],
[ 9.39744912, 10.85123956,  5.11532339],
[12.52993216, 10.85123956,  5.11532339],
[15.6624152 , 10.85123956,  5.11532339],
[18.79489824, 10.85123956,  5.11532339],
[21.92738128, 10.85123956,  5.11532339],
[ 7.8312076 , 13.56404945,  5.11532339],
[10.96369064, 13.56404945,  5.11532339],
[14.09617368, 13.56404945,  5.11532339],
[17.22865672, 13.56404945,  5.11532339],
[20.36113976, 13.56404945,  5.11532339],
[23.4936228 , 13.56404945,  5.11532339],
[ 1.56624152,  0.90426996,  7.67298508],
[ 4.69872456,  0.90426996,  7.67298508],
[ 7.8312076 ,  0.90426996,  7.67298508],
[10.96369064,  0.90426996,  7.67298508],
[14.09617368,  0.90426996,  7.67298508],
[17.22865672,  0.90426996,  7.67298508],
[ 3.13248304,  3.61707985,  7.67298508],
[ 6.26496608,  3.61707985,  7.67298508],
[ 9.39744912,  3.61707985,  7.67298508],
[12.52993216,  3.61707985,  7.67298508],
[15.6624152 ,  3.61707985,  7.67298508],
[18.79489824,  3.61707985,  7.67298508],
[ 4.69872456,  6.32988974,  7.67298508],
[ 7.8312076 ,  6.32988974,  7.67298508],
[10.96369064,  6.32988974,  7.67298508],
[14.09617368,  6.32988974,  7.67298508],
[17.22865672,  6.32988974,  7.67298508],
[20.36113976,  6.32988974,  7.67298508],
[ 6.26496608,  9.04269963,  7.67298508],
[ 9.39744912,  9.04269963,  7.67298508],
[12.52993216,  9.04269963,  7.67298508],
[15.6624152 ,  9.04269963,  7.67298508],
[18.79489824,  9.04269963,  7.67298508],
[21.92738128,  9.04269963,  7.67298508],
[ 7.8312076 , 11.75550952,  7.67298508],
[10.96369064, 11.75550952,  7.67298508],
[14.09617368, 11.75550952,  7.67298508],
[17.22865672, 11.75550952,  7.67298508],
[20.36113976, 11.75550952,  7.67298508],
[23.4936228 , 11.75550952,  7.67298508],
[ 9.39744912, 14.46831941,  7.67298508],
[12.52993216, 14.46831941,  7.67298508],
[15.6624152 , 14.46831941,  7.67298508],
[18.79489824, 14.46831941,  7.67298508],
[21.92738128, 14.46831941,  7.67298508],
[25.05986433, 14.46831941,  7.67298508],
[ 0.        ,  1.80853993, 10.23064677],
[ 3.13248304,  1.80853993, 10.23064677],
[ 6.26496608,  1.80853993, 10.23064677],
[ 9.39744912,  1.80853993, 10.23064677],
[12.52993216,  1.80853993, 10.23064677],
[15.6624152 ,  1.80853993, 10.23064677],
[ 1.56624152,  4.52134982, 10.23064677],
[ 4.69872456,  4.52134982, 10.23064677],
[ 7.8312076 ,  4.52134982, 10.23064677],
[10.96369064,  4.52134982, 10.23064677],
[14.09617368,  4.52134982, 10.23064677],
[17.22865672,  4.52134982, 10.23064677],
[ 3.13248304,  7.23415971, 10.23064677],
[ 6.26496608,  7.23415971, 10.23064677],
[ 9.39744912,  7.23415971, 10.23064677],
[12.52993216,  7.23415971, 10.23064677],
[15.6624152 ,  7.23415971, 10.23064677],
[18.79489824,  7.23415971, 10.23064677],
[ 4.69872456,  9.9469696 , 10.23064677],
[ 7.8312076 ,  9.9469696 , 10.23064677],
[10.96369064,  9.9469696 , 10.23064677],
[14.09617368,  9.9469696 , 10.23064677],
[17.22865672,  9.9469696 , 10.23064677],
[20.36113976,  9.9469696 , 10.23064677],
[ 6.26496608, 12.65977949, 10.23064677],
[ 9.39744912, 12.65977949, 10.23064677],
[12.52993216, 12.65977949, 10.23064677],
[15.6624152 , 12.65977949, 10.23064677],
[18.79489824, 12.65977949, 10.23064677],
[21.92738128, 12.65977949, 10.23064677],
[ 7.8312076 , 15.37258938, 10.23064677],
[10.96369064, 15.37258938, 10.23064677],
[14.09617368, 15.37258938, 10.23064677],
[17.22865672, 15.37258938, 10.23064677],
[20.36113976, 15.37258938, 10.23064677],
[23.4936228 , 15.37258938, 10.23064677],
[ 0.        ,  0.        , 12.78830846],
[ 3.13248304,  0.        , 12.78830846],
[ 6.26496608,  0.        , 12.78830846],
[ 9.39744912,  0.        , 12.78830846],
[12.52993216,  0.        , 12.78830846],
[15.6624152 ,  0.        , 12.78830846],
[ 1.56624152,  2.71280989, 12.78830846],
[ 4.69872456,  2.71280989, 12.78830846],
[ 7.8312076 ,  2.71280989, 12.78830846],
[10.96369064,  2.71280989, 12.78830846],
[14.09617368,  2.71280989, 12.78830846],
[17.22865672,  2.71280989, 12.78830846],
[ 3.13248304,  5.42561978, 12.78830846],
[ 6.26496608,  5.42561978, 12.78830846],
[ 9.39744912,  5.42561978, 12.78830846],
[12.52993216,  5.42561978, 12.78830846],
[15.6624152 ,  5.42561978, 12.78830846],
[18.79489824,  5.42561978, 12.78830846],
[ 4.69872456,  8.13842967, 12.78830846],
[ 7.8312076 ,  8.13842967, 12.78830846],
[10.96369064,  8.13842967, 12.78830846],
[14.09617368,  8.13842967, 12.78830846],
[17.22865672,  8.13842967, 12.78830846],
[20.36113976,  8.13842967, 12.78830846],
[ 6.26496608, 10.85123956, 12.78830846],
[ 9.39744912, 10.85123956, 12.78830846],
[12.52993216, 10.85123956, 12.78830846],
[15.6624152 , 10.85123956, 12.78830846],
[18.79489824, 10.85123956, 12.78830846],
[21.92738128, 10.85123956, 12.78830846],
[ 7.8312076 , 13.56404945, 12.78830846],
[10.96369064, 13.56404945, 12.78830846],
[14.09617368, 13.56404945, 12.78830846],
[17.22865672, 13.56404945, 12.78830846],
[20.36113976, 13.56404945, 12.78830846],
[23.4936228 , 13.56404945, 12.78830846]]

function write_vesta_file(filepath::String, positions::Array{Array{Float64, 1}, 1}, box_length::Float64, box_height::Float64)
    # Define the rhombic lattice vectors
    a_vector = [box_length, 0.0, 0.0]
    b_vector = [box_length / 2.0, box_height, 0.0]
    c_vector = [0.0, 0.0, box_height]
    lattice_vectors = [a_vector, b_vector, c_vector]
    
    # Compute lattice parameters
    a = norm(a_vector)
    b = norm(b_vector)
    c = norm(c_vector)
    alpha = acosd(dot(b_vector, c_vector) / (b * c))
    beta = acosd(dot(a_vector, c_vector) / (a * c))
    gamma = acosd(dot(a_vector, b_vector) / (a * b))
    
    open(filepath, "w") do io
        # CIF header
        println(io, "data_rhombic_structure")
        println(io, "_cell_length_a", @sprintf(" %.6f", a))
        println(io, "_cell_length_b", @sprintf(" %.6f", b))
        println(io, "_cell_length_c", @sprintf(" %.6f", c))
        println(io, "_cell_angle_alpha", @sprintf(" %.6f", alpha))
        println(io, "_cell_angle_beta", @sprintf(" %.6f", beta))
        println(io, "_cell_angle_gamma", @sprintf(" %.6f", gamma))
        
        # Atom positions
        println(io, "loop_")
        println(io, "_atom_site_label")
        println(io, "_atom_site_type_symbol")
        println(io, "_atom_site_fract_x")
        println(io, "_atom_site_fract_y")
        println(io, "_atom_site_fract_z")
        
        # Convert positions to fractional coordinates using lattice vectors
        lattice_matrix = hcat(lattice_vectors...)
        inv_lattice = inv(lattice_matrix)
        for (i, pos) in enumerate(positions)
            fractional = inv_lattice * pos
            println(io, @sprintf("Ar%d  Ar  %.6f  %.6f  %.6f", i, fractional[1], fractional[2], fractional[3]))
        end
    end
    println("File saved to $filepath")
end

#starting configurations
r_start = 3.7782 # r_start is the desired min. radius between atoms in the starting config.
L_start = 2 * (r_start^2 / 2)^0.5  # L_start refers to the distance between adjacent atoms parallel to x or y axis
scaling_factor_start = L_start / (4.3837 - 0)

# Inputs based on your provided information
AtoBohr = 1.8897259886   # Conversion factor
box_length = 18.79489824 * AtoBohr * scaling_factor_start
box_height = 15.34597014 * AtoBohr * scaling_factor_start

# Atomic positions
pos_ar216 = pos_ar216 * AtoBohr * scaling_factor_start

# Output file path
save_directory = "/Users/samuelcase/Dropbox/PTMC_Lit&Coding/Sam_Results/Data/Figs"
output_filename = "argon_rhombic_structure.cif"
output_filepath = joinpath(save_directory, output_filename)

# Generate the CIF file
write_vesta_file(output_filepath, pos_ar216, box_length, box_height)


