using ParallelTemperingMonteCarlo
using Random, DelimitedFiles

#demonstration of the new version of the new code   
script_folder = @__DIR__ # folder where this script is located
data_path = joinpath(script_folder, "data") # path to data files, so "./data/"
#-------------------------------------------------------#
#-----------------------MC Params-----------------------#
#-------------------------------------------------------#


Random.seed!(1234)
n_atoms = 124
ti = 750.
tf = 1200
n_traj = 20

temp = TempGrid{n_traj}(ti,tf) 

# MC simulation details

mc_cycles = 2000  #default 20% equilibration cycles on top


mc_sample = 1  #sample every mc_sample MC cycles

#move_atom=AtomMove(n_atoms) #move strategy (here only atom moves, n_atoms per MC cycle)
displ_atom = 0.1 # Angstrom
n_adjust = 100

max_displ_atom = [0.1*sqrt(displ_atom*temp.t_grid[i]) for i in 1:n_traj]

mc_params = MCParams(mc_cycles, n_traj, n_atoms, mc_sample = mc_sample, n_adjust = n_adjust)


#-------------------------------------------------------------#
#----------------------Potential------------------------------#
#-------------------------------------------------------------#

evtohartree = 0.0367493
nmtobohr = 18.8973
#parameters taken from L Vocadlo etal J Chem Phys V120N6 2004
n = 8.482
m = 4.692
ϵ = evtohartree*0.0370
a = 0.25*nmtobohr
C = 27.561

pot = EmbeddedAtomPotential(n,m,ϵ,C,a)

#-------------------------------------------------------------#
#------------------------Move Strategy------------------------#
#-------------------------------------------------------------#
ensemble = NVT(n_atoms)
move_strat = MoveStrategy(ensemble)

pos_cu124 = [[8.70179511, 8.74253542, 15.20569724],
[6.39005732, 9.75358828, 15.25634345],
[6.61765311, 7.32377865, 14.55786662], 
[11.05034427, 7.71147855, 15.07693457], 
[10.68145332, 10.13086906, 14.29873707], 
[8.95215825, 6.28895537, 14.51649622], 
[8.3182353, 11.14240391, 14.36256096], 
[6.88531337, 4.89028036, 13.78055486], 
[6.00700642, 11.23875004, 13.24598256], 
[4.94576416, 8.89361261, 13.36669836], 
[5.15678215, 6.4335647, 12.64394147], 
[13.01190572, 9.06859737, 14.10950973], 
[13.34987945, 6.6843243, 14.87463704], 
[12.63667652, 11.46459509, 13.26536007], 
[11.30412764, 5.28095828, 14.34078155], 
[9.74024858, 8.14863095, 13.02035174], 
[10.28746721, 12.50458077, 13.3917089], 
[7.42492934, 9.16534803, 13.09583556], 
[9.23230078, 3.91385558, 13.70922707], 
[5.99871863, 8.30510419, 11.19266601], 
[7.9454019, 4.23288974, 11.59108509], 
[7.95609414, 12.65935228, 12.31648828], 
[14.5021434, 7.49366285, 12.76369186], 
[14.17290686, 9.90108614, 11.94187368], 
[5.46681702, 4.05279617, 11.8240602], 
[5.66014175, 12.70257168, 11.1593427], 
[4.54210452, 10.38426005, 11.30665058], 
[12.22700298, 13.79132921, 12.37801925], 
[12.0371332, 7.1231784, 12.82870617], 
[3.54205533, 8.01399058, 11.39505893], 
[11.69410876, 9.50025226, 12.05679448], 
[3.80394432, 5.57565363, 10.62929223], 
[9.98809339, 5.7172287, 12.24761517], 
[9.35401233, 10.54281637, 12.18452533], 
[7.66823572, 6.71495781, 12.36714964], 
[7.05224715, 10.64070261, 11.07843206], 
[5.65104755, 9.76388025, 9.11451737], 
[13.46394793, 5.11970212, 12.91077999], 
[6.28366785, 5.86407058, 10.42128804], 
[13.16517302, 7.91527462, 10.68094905], 
[12.06906536, 13.82139289, 9.85390747], 
[11.40006115, 3.70866629, 12.36849139], 
[11.29447089, 11.84245977, 11.18758109], 
[10.74939703, 7.53933543, 10.80139553], 
[9.9442686, 13.96241853, 11.30397983], 
[10.0908909, 4.03334811, 10.217075], 
[8.45920111, 8.56402333, 10.94888414], 
[8.7214727, 6.10793105, 10.17275561], 
[7.70252841, 4.13122729, 9.0286544], 
[12.80691368, 10.26982886, 9.83313148], 
[5.35996431, 14.09420268, 9.06635852], 
[14.62064199, 5.93673309, 10.78051744], 
[13.74219103, 12.25274619, 11.04394633], 
[4.25139147, 11.81985064, 9.18785824], 
[5.19224168, 3.9587829, 9.24325289], 
[3.19591732, 9.47468716, 9.30517704], 
[12.17067381, 5.50180832, 10.8246576], 
[2.22922917, 7.13997595, 9.4133909], 
[9.01357135, 11.99805452, 10.11056794], 
[10.38071115, 9.89334495, 10.00136866], 
[10.84143778, 5.97635916, 8.79536507], 
[7.63011274, 14.06638642, 10.18588487], 
[10.09753096, 7.50694058, 2.54652551], 
[9.85042498, 9.93916444, 3.24723567], 
[7.77292073, 8.53267812, 2.69458888], 
[9.58817491, 12.35418008, 4.09559984], 
[7.50275185, 10.97091934, 3.47579587], 
[5.47181929, 9.55989657, 2.9307034], 
[12.15800674, 8.86684457, 3.16686494], 
[8.09959619, 6.12059934, 3.43624639], 
[11.92626868, 11.28475277, 3.93132957], 
[11.48391584, 6.88215046, 4.53093442], 
[5.78943412, 7.16115928, 3.67221824], 
[9.13990335, 7.98369714, 4.72767755], 
[11.65321274, 13.65804692, 4.76604231], 
[13.63361221, 9.79635252, 5.08176424], 
[8.85227831, 10.43437119, 5.49156314], 
[4.32121899, 8.77076498, 5.04449028], 
[6.81852167, 9.03860191, 4.9315605], 
[6.15189008, 4.77905855, 4.49137352], 
[9.55853473, 13.8755421, 6.1671765], 
[13.35214636, 12.17983553, 5.92073785], 
[7.445587, 12.54877653, 5.50690753], 
[12.96544857, 7.77099474, 6.43394274], 
[5.38568384, 11.10782316, 4.92914914], 
[9.52363242, 5.47983423, 5.4268442], 
[11.18765859, 9.3393078, 5.34072289], 
[4.6389086, 6.33570454, 5.81623564], 
[7.17346737, 6.6240737, 5.69692477], 
[11.89093685, 5.37682781, 6.62961702], 
[10.91035629, 11.75287326, 6.14667574], 
[14.99152964, 10.64142108, 7.12742028], 
[10.48719701, 7.40166499, 6.71666932], 
[5.68840848, 8.2462798, 7.05155978], 
[8.16195962, 8.50681522, 6.91054074], 
[5.08022968, 3.97322628, 6.65498704], 
[14.31214947, 8.63740108, 8.45142959], 
[11.87384464, 13.77701602, 7.28625038], 
[8.81962948, 11.95561778, 7.5519933], 
[12.60024211, 10.23341898, 7.30675897], 
[7.56585175, 4.17321877, 6.4621655], 
[6.74230344, 10.57671906, 6.93573961], 
[3.22701684, 7.95482201, 7.23238437], 
[7.43577079, 14.02161708, 7.6168243], 
[5.34782056, 12.63640266, 6.99800821], 
[6.10350027, 5.82344242, 7.84677631], 
[15.5736398, 8.30138839, 10.58203272], 
[9.91234659, 4.00864968, 7.60500744], 
[11.86741581, 8.28425608, 8.62151276], 
[9.75727653, 13.99129957, 8.73431096], 
[13.59755161, 12.27251861, 8.48127222], 
[8.56222831, 6.07056014, 7.66556326], 
[10.18188844, 9.8498387, 7.5115859], 
[4.22525455, 10.32176994, 7.09526883], 
[7.09992889, 7.71815114, 9.03099606], 
[12.22623493, 3.98160706, 8.80470991], 
[3.61329438, 5.53588185, 8.02960605], 
[13.33864696, 6.28011801, 8.61561831], 
[9.47895188, 7.97375589, 8.83446904], 
[11.12640121, 11.85215529, 8.66431717], 
[15.20944499, 10.64907533, 9.67536612], 
[8.11646901, 10.00845422, 8.92578112], 
[4.67116185, 7.43720734, 9.22307017], 
[6.73827459, 12.04973065, 8.9968049]]
AtoBohr = 1.8897259886

cofm = [sum([pos[1] for pos in pos_cu124]),sum([pos[2] for pos in pos_cu124]),sum([pos[3] for pos in pos_cu124])]./124

for element in pos_cu124
    element .-=cofm 
end

length(pos_cu124) == n_atoms || error("number of atoms and positions not the same - check starting config")

n_bin = 100

#boundary conditions
bc_cu124 = SphericalBC(radius=16*AtoBohr)   #5.32 Angstrom
start_config = Config(pos_cu124, bc_cu124)
@time states,results = ptmc_run!(mc_params,temp,start_config,pot,ensemble;save=1000)

